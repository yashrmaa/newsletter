name: Generate Daily AI Newsletter

on:
  # Run daily at 2 PM UTC (7 AM Pacific)
  schedule:
    - cron: '0 14 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on pushes to main (for testing)
  push:
    branches: [ main ]
    paths:
      - 'ai_blogs.md'
      - 'src/**'
      - 'config/**'
      - 'templates/**'
      - 'docs/_config.yml'
      - 'docs/_layouts/**'
      - 'docs/Gemfile'
      - '.github/workflows/**'

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-newsletter:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4

    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“‹ Install dependencies
      run: npm ci

    - name: ğŸ”§ Setup environment
      run: |
        echo "Environment configured for ${{ secrets.LLM_PROVIDER || 'free' }} provider"
        echo "Repository: ${{ github.repository }}"
        echo "Running in GitHub Pages mode (local file output)"

    - name: ğŸ¤– Generate AI Newsletter
      env:
        LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'free' }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        MONTHLY_BUDGET_LIMIT: ${{ secrets.MONTHLY_BUDGET_LIMIT || '0.00' }}
        NODE_ENV: production
        # Don't set GitHub credentials to force local mode
      run: |
        echo "ğŸš€ Starting newsletter generation..."
        npm run generate
        echo "âœ… Newsletter generation completed"
        echo "ğŸ“ Files generated:"
        ls -la docs/
        echo "ğŸ“„ Newsletter preview (README.md):"
        head -20 docs/README.md
        echo ""
        echo "ğŸ“š Archive index preview (index.md):"
        head -10 docs/index.md

    - name: ğŸ’ Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: false

    - name: ğŸ—ï¸ Build Jekyll site
      run: |
        cd docs
        echo "ğŸ“ Current directory contents:"
        ls -la
        echo ""
        echo "ğŸ“„ Checking Jekyll config:"
        cat _config.yml | head -20
        echo ""
        echo "ğŸ’ Installing bundler..."
        gem install bundler
        bundle config set --local path 'vendor/bundle'
        echo ""
        echo "ğŸ“¦ Installing Jekyll dependencies..."
        bundle install
        echo ""
        echo "ğŸ”¨ Building Jekyll site..."
        bundle exec jekyll build --baseurl /newsletter --trace
        echo ""
        echo "ğŸ“ Built site contents:"
        ls -la _site/
        echo ""
        echo "ğŸ“„ Checking if README.html was generated:"
        ls -la _site/README.html || echo "âŒ README.html not found!"
        echo ""
        echo "ğŸ“„ Checking if index.html was generated:"
        ls -la _site/index.html || echo "âŒ index.html not found!"
      env:
        JEKYLL_ENV: production

    - name: ğŸ“¤ Setup Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“ Verify built site
      run: |
        echo "ğŸ” Verifying _site directory before upload:"
        pwd
        ls -la
        echo "ğŸ“‚ Built site contents:"
        ls -la docs/_site/ || (echo "âŒ ERROR: _site directory not found!" && exit 1)
        echo "ğŸ“ File sizes:"
        du -h docs/_site/* || echo "Warning: Could not get file sizes"
        echo ""
        echo "ğŸ” Checking critical files:"
        test -f docs/_site/README.html && echo "âœ… README.html exists" || echo "âŒ README.html missing"
        test -f docs/_site/index.html && echo "âœ… index.html exists" || echo "âŒ index.html missing"
        test -f docs/_site/2025-08-31.html && echo "âœ… 2025-08-31.html exists" || echo "â„¹ï¸ 2025-08-31.html not found (may be expected)"
    
    - name: ğŸ“ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs/_site'

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ“ Log deployment
      run: |
        echo "ğŸ‰ Newsletter successfully deployed!"
        echo "ğŸ“„ URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“Š Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # Health check job (simplified)
  health-check:
    needs: [generate-newsletter] 
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“Š Health Check Summary
      run: |
        echo "ğŸ” Newsletter Generation Health Check"
        echo "====================================="
        echo "ğŸ“° Generation: ${{ needs.generate-newsletter.result }}"
        echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        
        if [[ "${{ needs.generate-newsletter.result }}" == "success" ]]; then
          echo "âœ… Newsletter generation and deployment successful"
          echo "ğŸŒ Your newsletter is live at the GitHub Pages URL"
        else
          echo "âŒ Newsletter generation failed"
          echo "ğŸ”§ Check the workflow logs for details"
          exit 1
        fi
name: Generate Daily AI Newsletter

on:
  # Run daily at 2 PM UTC (7 AM Pacific)
  schedule:
    - cron: '0 14 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on pushes to main (for testing)
  push:
    branches: [ main ]
    paths:
      - 'ai_blogs.md'
      - 'src/**'
      - 'config/**'
      - 'templates/**'

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-newsletter:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: 📦 Checkout repository
      uses: actions/checkout@v4

    - name: ⚡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: 📋 Install dependencies
      run: npm ci

    - name: 🔧 Setup environment
      run: |
        echo "Environment configured for ${{ secrets.LLM_PROVIDER || 'free' }} provider"
        echo "Repository: ${{ github.repository }}"
        echo "Running in GitHub Pages mode (local file output)"

    - name: 🤖 Generate AI Newsletter
      env:
        LLM_PROVIDER: ${{ secrets.LLM_PROVIDER || 'free' }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        MONTHLY_BUDGET_LIMIT: ${{ secrets.MONTHLY_BUDGET_LIMIT || '0.00' }}
        NODE_ENV: production
        # Don't set GitHub credentials to force local mode
      run: |
        echo "🚀 Starting newsletter generation..."
        npm run generate
        echo "✅ Newsletter generation completed"
        echo "📁 Files generated:"
        ls -la output/
        echo "📄 Newsletter preview (README.md):"
        head -20 output/README.md
        echo ""
        echo "📚 Archive index preview (index.md):"
        head -10 output/index.md

    - name: 📤 Setup Pages
      uses: actions/configure-pages@v4

    - name: 📁 Verify output directory
      run: |
        echo "🔍 Verifying output directory before upload:"
        pwd
        ls -la
        echo "📂 Output directory contents:"
        ls -la output/
        echo "📏 File sizes:"
        du -h output/*
    
    - name: 📁 Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './output'

    - name: 🚀 Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: 📝 Log deployment
      run: |
        echo "🎉 Newsletter successfully deployed!"
        echo "📄 URL: ${{ steps.deployment.outputs.page_url }}"
        echo "📊 Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # Health check job (simplified)
  health-check:
    needs: [generate-newsletter] 
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: 📊 Health Check Summary
      run: |
        echo "🔍 Newsletter Generation Health Check"
        echo "====================================="
        echo "📰 Generation: ${{ needs.generate-newsletter.result }}"
        echo "⏰ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        
        if [[ "${{ needs.generate-newsletter.result }}" == "success" ]]; then
          echo "✅ Newsletter generation and deployment successful"
          echo "🌐 Your newsletter is live at the GitHub Pages URL"
        else
          echo "❌ Newsletter generation failed"
          echo "🔧 Check the workflow logs for details"
          exit 1
        fi